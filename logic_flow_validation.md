# –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Ç–æ–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –ø–∞—É–∑—ã

## –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ maintain_all_bots_active_bets()

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
```
1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤: active_bots = await db.bots.find({"is_active": True, "bot_type": "REGULAR"})
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ:
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
```
2.1. bot_id = bot_doc["id"]
2.2. fresh_bot_doc = await db.bots.find_one({"id": bot_id})  ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
2.3. –ï—Å–ª–∏ fresh_bot_doc None –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω ‚Üí continue
2.4. cycle_games = fresh_bot_doc.get("cycle_games", 12)
```

### 3. –ü–æ–¥—Å—á–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
```
3.1. current_active_bets = count WAITING games –¥–ª—è bot_id
3.2. current_wins = fresh_bot_doc.get("current_cycle_wins", 0)
3.3. current_losses = fresh_bot_doc.get("current_cycle_losses", 0)
3.4. current_draws = fresh_bot_doc.get("current_cycle_draws", 0)
3.5. games_played = current_wins + current_losses + current_draws
3.6. cycle_completed = games_played >= cycle_games
```

### 4. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

#### –í–µ—Ç–∫–∞ A: current_active_bets > 0
```
–î–µ–π—Å—Ç–≤–∏–µ: continue (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º)
–õ–æ–≥–∏: "Bot X: Y active bets, cycle progress: Z/W"
```

#### –í–µ—Ç–∫–∞ B: current_active_bets == 0 AND cycle_completed == True
```
B.1. last_cycle_completed_at = fresh_bot_doc.get("last_cycle_completed_at")
B.2. pause_between_cycles = fresh_bot_doc.get("pause_between_cycles", 5)

  –ü–æ–¥–≤–µ—Ç–∫–∞ B.1: last_cycle_completed_at == None
  ```
  –î–µ–π—Å—Ç–≤–∏–µ: –ù–∞—á–∞—Ç—å –ø–∞—É–∑—É
  1. cycle_completion_time = datetime.utcnow()
  2. UPDATE bots SET last_cycle_completed_at = cycle_completion_time WHERE id = bot_id
  3. continue (–Ω–µ —Å–æ–∑–¥–∞–µ–º —Ü–∏–∫–ª)
  –õ–æ–≥–∏: "üèÅ Bot X: cycle completed, starting pause of Ys before next cycle"
  ```

  –ü–æ–¥–≤–µ—Ç–∫–∞ B.2: last_cycle_completed_at != None
  ```
  1. current_time = datetime.utcnow()
  2. time_since_completion = (current_time - last_cycle_completed_at).total_seconds()
  
    –ü–æ–¥–ø–æ–¥–≤–µ—Ç–∫–∞ B.2.1: time_since_completion < pause_between_cycles
    ```
    –î–µ–π—Å—Ç–≤–∏–µ: –ü–∞—É–∑–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
    1. remaining_pause = pause_between_cycles - time_since_completion
    2. continue (–Ω–µ —Å–æ–∑–¥–∞–µ–º —Ü–∏–∫–ª)
    –õ–æ–≥–∏: "üïê Bot X: pause in progress, Y.Ys remaining"
    ```
    
    –ü–æ–¥–ø–æ–¥–≤–µ—Ç–∫–∞ B.2.2: time_since_completion >= pause_between_cycles
    ```
    –î–µ–π—Å—Ç–≤–∏–µ: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª
    1. DELETE games WHERE creator_id = bot_id AND status = "COMPLETED"
    2. UPDATE bots SET current_cycle_wins=0, losses=0, draws=0, profit=0.0, UNSET last_cycle_completed_at
    3. updated_bot_doc = SELECT bot WHERE id = bot_id
    4. create_full_bot_cycle(updated_bot_doc)
    –õ–æ–≥–∏: "‚úÖ Bot X: pause completed, creating new cycle"
           "üóëÔ∏è Bot X: deleted Y completed games"
           "‚úÖ Bot X created new cycle of Z bets"
    ```
  ```
```

#### –í–µ—Ç–∫–∞ C: current_active_bets == 0 AND cycle_completed == False AND games_played == 0
```
–î–µ–π—Å—Ç–≤–∏–µ: –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ü–∏–∫–ª
1. create_full_bot_cycle(fresh_bot_doc)
–õ–æ–≥–∏: "üéØ Bot X: starting initial cycle"
      "‚úÖ Bot X created initial cycle of Y bets"
```

#### –í–µ—Ç–∫–∞ D: current_active_bets == 0 AND cycle_completed == False AND games_played > 0
```
–î–µ–π—Å—Ç–≤–∏–µ: –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º (—Ü–∏–∫–ª –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –Ω–æ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫)
–õ–æ–≥–∏: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è)
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏–∫–∏

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –±–æ—Ç
```
–°–æ—Å—Ç–æ—è–Ω–∏–µ: games_played = 0, current_active_bets = 0, cycle_completed = False
–í–µ—Ç–∫–∞: C
–†–µ–∑—É–ª—å—Ç–∞—Ç: –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π —Ü–∏–∫–ª ‚úÖ
```

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 2: –¶–∏–∫–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
```
–°–æ—Å—Ç–æ—è–Ω–∏–µ: games_played = 12, current_active_bets = 0, cycle_completed = True, last_cycle_completed_at = None
–í–µ—Ç–∫–∞: B ‚Üí B.1
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–∞—É–∑–∞, —Ü–∏–∫–ª –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è ‚úÖ
```

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–∞—É–∑–∞ –∞–∫—Ç–∏–≤–Ω–∞
```
–°–æ—Å—Ç–æ—è–Ω–∏–µ: games_played = 12, current_active_bets = 0, cycle_completed = True, 
           last_cycle_completed_at = 3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞–∑–∞–¥, pause_between_cycles = 10
–í–µ—Ç–∫–∞: B ‚Üí B.2 ‚Üí B.2.1
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–∞—É–∑–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, —Ü–∏–∫–ª –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è ‚úÖ
```

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ü–∞—É–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
```
–°–æ—Å—Ç–æ—è–Ω–∏–µ: games_played = 12, current_active_bets = 0, cycle_completed = True,
           last_cycle_completed_at = 15 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥, pause_between_cycles = 10
–í–µ—Ç–∫–∞: B ‚Üí B.2 ‚Üí B.2.2
–†–µ–∑—É–ª—å—Ç–∞—Ç: –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ü–∏–∫–ª ‚úÖ
```

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞ (—Å–ª–µ–¥—É—é—â–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è)
```
–°–æ—Å—Ç–æ—è–Ω–∏–µ: games_played = 0 (—Å–±—Ä–æ—à–µ–Ω), current_active_bets = 12 (–Ω–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏), cycle_completed = False
–í–µ—Ç–∫–∞: A
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç (–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –µ—Å—Ç—å) ‚úÖ
```

### ‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 6: –¶–∏–∫–ª –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
```
–°–æ—Å—Ç–æ—è–Ω–∏–µ: games_played = 5, current_active_bets = 7, cycle_completed = False
–í–µ—Ç–∫–∞: A  
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç ‚úÖ
```

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å–¥–µ–ª–∞–Ω—ã:

### üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –°–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –±–æ—Ç–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ `bot_doc` –∏–∑ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `fresh_bot_doc = await db.bots.find_one({"id": bot_id})` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞

### üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è create_full_bot_cycle
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ create_full_bot_cycle
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `updated_bot_doc = await db.bots.find_one({"id": bot_id})` –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞

### üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ `bot_doc['name']`
**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `fresh_bot_doc.get('name', 'Unknown')`

## –û—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ 1: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥—ã–π –±–æ—Ç –¥–µ–ª–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î
**–û—Ü–µ–Ω–∫–∞:** –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–æ—Ç–æ–≤ (<100)

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ 2: Race conditions
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–∂–¥—É –ø–æ–ª—É—á–µ–Ω–∏–µ–º fresh_bot_doc –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
**–û—Ü–µ–Ω–∫–∞:** –ú–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ 3: –ß–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ datetime.utcnow() –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –≤—Ä–µ–º–µ–Ω–∏
**–û—Ü–µ–Ω–∫–∞:** –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è

## –í—ã–≤–æ–¥: –õ–æ–≥–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ ‚úÖ

–ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
1. –ü–∞—É–∑–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ü–∏–∫–ª–∞
2. –ü–∞—É–∑–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. –ù–æ–≤—ã–π —Ü–∏–∫–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–∞—É–∑—ã
4. –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π